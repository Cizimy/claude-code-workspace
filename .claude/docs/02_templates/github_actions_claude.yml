# Claude Code GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# 
# ä½¿ç”¨æ–¹æ³•:
# 1. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .github/workflows/claude.yml ã¨ã—ã¦ã‚³ãƒ”ãƒ¼
# 2. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ ([PROJECT_NAME] ç­‰) ã‚’å®Ÿéš›ã®å€¤ã«ç½®æ›
# 3. Secretsè¨­å®š: CLAUDE_API_KEY, GITHUB_TOKEN
# 4. å¿…è¦ã«å¿œã˜ã¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è¨­å®šã‚’è¿½åŠ 

name: Claude Code AI-Driven Development

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, synchronize]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string
      command:
        description: 'Claude command to execute'
        required: false
        default: 'analyze'
        type: choice
        options:
          - analyze
          - new-feature
          - fix-bug
          - review

# ä¸¦è¡Œå®Ÿè¡Œã®åˆ¶å¾¡ï¼ˆè¤‡æ•°ã®Claude Codeã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è¡çªã‚’é˜²ãï¼‰
concurrency:
  group: claude-${{ github.repository }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

env:
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è¨­å®š
  PROJECT_NAME: "[PROJECT_NAME]"
  MIN_COVERAGE_THRESHOLD: "[MIN_COVERAGE]"  # ä¾‹: 80
  DEFAULT_BRANCH: "[DEFAULT_BRANCH]"        # ä¾‹: main
  NODE_VERSION: "[NODE_VERSION]"            # ä¾‹: 18 (Node.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ)
  PYTHON_VERSION: "[PYTHON_VERSION]"        # ä¾‹: 3.9 (Pythonãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ)

jobs:
  # Issue ãƒˆãƒªã‚¬ãƒ¼ã§ã® Claude Code å®Ÿè¡Œ
  claude-issue-handler:
    if: github.event_name == 'issues' || github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Claude Code Trigger Detection
        id: claude-trigger
        run: |
          # @claude ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã®æ¤œå‡º
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            COMMENT="${{ github.event.comment.body }}"
            if [[ "$COMMENT" =~ @claude ]]; then
              echo "triggered=true" >> $GITHUB_OUTPUT
              echo "trigger_type=mention" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "issues" && "${{ github.event.action }}" == "opened" ]]; then
            # æ–°ã—ã„Issueã§ç‰¹å®šãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆ
            LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
            if [[ "$LABELS" =~ (claude|ai-dev|tdd|automated) ]]; then
              echo "triggered=true" >> $GITHUB_OUTPUT
              echo "trigger_type=label" >> $GITHUB_OUTPUT
            fi
          fi
          
      - name: Setup [PROGRAMMING_LANGUAGE] Environment
        if: steps.claude-trigger.outputs.triggered == 'true'
        # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ã¦é©åˆ‡ãªsetup actionã‚’ä½¿ç”¨
        uses: actions/setup-[SETUP_ACTION]@v4  # setup-node, setup-python, etc.
        with:
          [LANGUAGE_VERSION_KEY]: ${{ env.[LANGUAGE_VERSION_ENV] }}  # node-version, python-version, etc.
          cache: '[PACKAGE_MANAGER]'  # npm, pip, etc.
          
      - name: Install Dependencies
        if: steps.claude-trigger.outputs.triggered == 'true'
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          [INSTALL_COMMAND]  # npm install, pip install -r requirements.txt, etc.
          
      - name: Claude Code Execution
        if: steps.claude-trigger.outputs.triggered == 'true'
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Claude Code ã®å®Ÿè¡Œ
          # æ³¨æ„: å®Ÿéš›ã®Claude Code CLIã®ä½¿ç”¨æ–¹æ³•ã«å¿œã˜ã¦èª¿æ•´ãŒå¿…è¦
          
          # Issueå†…å®¹ã‹ã‚‰é©åˆ‡ãªã‚³ãƒãƒ³ãƒ‰ã‚’åˆ¤å®š
          ISSUE_BODY="${{ github.event.issue.body || github.event.comment.body }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # ãƒ©ãƒ™ãƒ«ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒãƒ³ãƒ‰åˆ¤å®š
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          
          if [[ "$LABELS" =~ feature ]]; then
            COMMAND="/project:new-feature $ISSUE_NUMBER"
          elif [[ "$LABELS" =~ bug ]]; then
            COMMAND="/project:fix-bug $ISSUE_NUMBER"
          else
            COMMAND="analyze issue $ISSUE_NUMBER and suggest appropriate action"
          fi
          
          echo "Executing Claude Code with command: $COMMAND"
          
          # Claude Codeå®Ÿè¡Œï¼ˆå®Ÿéš›ã®API/CLIå‘¼ã³å‡ºã—ï¼‰
          # ã“ã®éƒ¨åˆ†ã¯ Claude Code ã®æ­£å¼ãªGitHub Actions integrationã«ç½®ãæ›ãˆã‚‹
          echo "Claude Code execution would happen here with: $COMMAND"
          
      - name: TDD Compliance Check
        if: steps.claude-trigger.outputs.triggered == 'true'
        run: |
          # TDDæº–æ‹ ãƒã‚§ãƒƒã‚¯ï¼ˆHooksæ©Ÿèƒ½ã®çµ±åˆï¼‰
          echo "Running TDD compliance checks..."
          
          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          if [[ -d "tests" || -d "test" ]]; then
            echo "âœ… Test directory found"
          else
            echo "âŒ No test directory found"
            exit 1
          fi
          
          # åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          [TEST_COMMAND]  # npm test, pytest, etc.
          
      - name: Coverage Check
        if: steps.claude-trigger.outputs.triggered == 'true'
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
          echo "Running coverage analysis..."
          
          [COVERAGE_COMMAND]  # npm run coverage, pytest --cov, etc.
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
          # å®Ÿéš›ã®ã‚«ãƒãƒ¬ãƒƒã‚¸å–å¾—ã¨é–¾å€¤æ¯”è¼ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
          
      - name: Code Quality Checks
        if: steps.claude-trigger.outputs.triggered == 'true'
        run: |
          # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          echo "Running code quality checks..."
          
          # Lintå®Ÿè¡Œ
          [LINT_COMMAND]  # npm run lint, ruff check, etc.
          
          # æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰æ¤œå‡º
          # vulture . (Python) or similar tools
          
      - name: Update Issue/PR
        if: steps.claude-trigger.outputs.triggered == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å®Ÿè¡Œçµæœã‚’Issue/PRã«å ±å‘Š
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          
          # æˆåŠŸ/å¤±æ•—ã«å¿œã˜ãŸã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ
          COMMENT="ğŸ¤– **Claude Codeå®Ÿè¡Œå®Œäº†**

          **å®Ÿè¡Œå†…å®¹**: ${{ steps.claude-trigger.outputs.trigger_type }}
          **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æˆåŠŸ
          **å®Ÿè¡Œæ™‚åˆ»**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          **å“è³ªãƒã‚§ãƒƒã‚¯çµæœ**:
          - âœ… TDDæº–æ‹ ãƒã‚§ãƒƒã‚¯: åˆæ ¼
          - âœ… ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: $MIN_COVERAGE_THRESHOLD% ä»¥ä¸Š
          - âœ… ã‚³ãƒ¼ãƒ‰å“è³ª: Lintåˆæ ¼
          - âœ… æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰: æ¤œå‡ºãªã—

          è©³ç´°ã¯[Actionså®Ÿè¡Œãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          
          # GitHub CLI ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
          echo "$COMMENT" | gh issue comment $ISSUE_NUMBER --body-file -

  # Pull Request ã§ã®å“è³ªã‚²ãƒ¼ãƒˆ
  claude-pr-quality-gate:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      checks: write
      
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup [PROGRAMMING_LANGUAGE] Environment
        uses: actions/setup-[SETUP_ACTION]@v4
        with:
          [LANGUAGE_VERSION_KEY]: ${{ env.[LANGUAGE_VERSION_ENV] }}
          cache: '[PACKAGE_MANAGER]'
          
      - name: Install Dependencies
        run: [INSTALL_COMMAND]
        
      - name: Run Full Test Suite
        run: |
          echo "Running comprehensive test suite for PR..."
          [TEST_COMMAND]
          
      - name: TDD Compliance Verification
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆã®å­˜åœ¨ç¢ºèª
          echo "Verifying TDD compliance for changed files..."
          
          # Git diff ã‚’ä½¿ç”¨ã—ã¦å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          
          echo "Changed files: $CHANGED_FILES"
          
          # TDDæº–æ‹ ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
          # å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          
      - name: Coverage Report
        run: |
          echo "Generating coverage report..."
          [COVERAGE_COMMAND]
          
          # PRã¸ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆæŠ•ç¨¿
          # ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æŠ•ç¨¿
          
      - name: YAGNI Compliance Check
        run: |
          echo "Checking YAGNI compliance..."
          
          # æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰ã®æ¤œå‡º
          # æ–°è¦è¿½åŠ ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŒå®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          
      - name: PR Status Update
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # PRå“è³ªã‚²ãƒ¼ãƒˆã®çµæœã‚’å ±å‘Š
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # å“è³ªãƒã‚§ãƒƒã‚¯çµæœã®ã‚µãƒãƒªä½œæˆ
          SUMMARY="## ğŸ›¡ï¸ Claude Codeå“è³ªã‚²ãƒ¼ãƒˆçµæœ

          | ãƒã‚§ãƒƒã‚¯é …ç›® | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |
          |-------------|------------|------|
          | ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ | âœ… | å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼ |
          | TDDæº–æ‹  | âœ… | å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆå¤‰æ›´ç¢ºèª |
          | ã‚«ãƒãƒ¬ãƒƒã‚¸ | âœ… | $MIN_COVERAGE_THRESHOLD% ä»¥ä¸Šç¶­æŒ |
          | YAGNIæº–æ‹  | âœ… | æœªä½¿ç”¨ã‚³ãƒ¼ãƒ‰æ¤œå‡ºãªã— |

          **æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: âœ… ãƒãƒ¼ã‚¸å¯èƒ½"
          
          echo "$SUMMARY" | gh pr comment $PR_NUMBER --body-file -

# å®šæœŸçš„ãªå“è³ªç›£è¦–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  scheduled-quality-check:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Environment
        uses: actions/setup-[SETUP_ACTION]@v4
        with:
          [LANGUAGE_VERSION_KEY]: ${{ env.[LANGUAGE_VERSION_ENV] }}
          
      - name: Health Check
        run: |
          echo "Running scheduled quality health check..."
          
          # å…¨ä½“çš„ãªå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†
          # ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ‡ãƒƒãƒˆã®è“„ç©ãƒã‚§ãƒƒã‚¯
          # é•·æœŸå“è³ªãƒˆãƒ¬ãƒ³ãƒ‰ã®åˆ†æ
          
      - name: Report Generation
        run: |
          echo "Generating quality report..."
          
          # å“è³ªãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã¨ä¿å­˜
          # å¿…è¦ã«å¿œã˜ã¦Slack/Discordç­‰ã¸ã®é€šçŸ¥