## 「複雑性制御アーキテクチャ」を **“より シンプルに・より 強力に”** する改善戦略

（`ai_perfectionism_prevention_plan.md` と最新ベストプラクティスレポートを統合）

---

### 1. 方針サマリ ― **“制御の複雑化” ≠ “複雑性の制御”**

| 現状の強み                                             | 潜在的リスク                                                      | 改善のキー                                     |
| ------------------------------------------------- | ----------------------------------------------------------- | ----------------------------------------- |
| 3 層アーキテクチャ＋ TDD×YAGNI×Hooks が明確で“網羅的”【turn0file1】 | ドキュメント・Hook・計測ツールが**散在**し肥大化傾向（行数 780→今後再膨張の懸念）【turn0file0】 | ① **統合と抽象化** ② **動的しきい値** ③ **学習ループの自動化** |

---

### 2. 改善ステップ（MECE）

| ステップ                      | 目的                   | 具体施策                                                                                                                    | 期待効果                                     |
| ------------------------- | -------------------- | ----------------------------------------------------------------------------------------------------------------------- | ---------------------------------------- |
| **A. ガード統廃合**             | Hook スクリプト乱立抑止       | *quality-gate.sh* に **Pre / Post / Stop** を 1 枚で実装<br>‐ モジュール化関数：`check_tdd  check_unused  check_coverage  check_lines` | ✅ 保守対象を 1 ファイルに削減<br>✅ 複合チェック時の重複 I/O 解消 |
| **B. 動的パラメータ化**           | “しきい値ハードコード” 問題解消    | `quality-gate.yaml` でプロジェクト別閾値を管理<br>Hook では `yq` 読み込みのみ                                                                | ✅ 行数・ファイル数・カバレッジ閾値を **コード変更無しで調整**       |
| **C. CLAUDE.md 最小核化**     | AI完璧主義対策の **重複記述除去** | *AI完璧主義対策* 節は「禁止事項＋自己チェック質問」のみ残し、詳細ガイダンスは `doc/anti_perfectionism.md` へ分離【turn0file0】                                   | ✅ CLAUDE.md を < 150 行に維持 → モデルの記憶効率↑     |
| **D. “教育的ブロック” メッセージ最適化** | Claude 混乱を防ぐ         | - 出力フォーマットを **Markdown 箇条書きのみ** に統一<br>- 原因→対処→再試行例 の３段構成                                                               | ✅ Claude の再試行成功率↑、エラーメッセージの再利用性↑         |
| **E. 学習ループ自動化**           | “違反→手動反映” を排除        | - Stop Hook で違反 JSON を `/logs/violations.jsonl` に追記<br>- 週次バッチで **頻出違反をランキング** → Slack 通知                               | ✅ ヒューマンレビュー無しで **次の改善点を可視化**             |
| **F. 軽量 KPI ダッシュボード**     | 行数の少ないメトリクス可視化       | - `sqlite + Observable Plot` で **HTML 1 ファイル** ダッシュボード生成<br>- メトリクスは *violations / coverage / PR size* の３種に絞る           | ✅ Grafana 等フルスタック導入を先送りしつつ “見える化”        |

---

### 3. 施策詳細

#### A. ガード統廃合 ― *quality-gate.sh*

```bash
# quality-gate.sh (pseudo)
source "$(dirname "$0")/lib/helpers.sh"

phase="$1"   # pre|post|stop
load_yaml_config "quality-gate.yaml"   # thresholds.*

case "$phase" in
  pre)  check_tdd "$FILE" ;;
  post) check_unused "$FILE" "$LANG" ;;
  stop) check_coverage "$PROJECT"; tail -n +1 "$VIOLATION_LOG" ;;
esac
```

* シェル１枚＋共通ライブラリでロジック重複を排除
* YAML で閾値を吸い上げるため、**言語追加やしきい値変更が PR 1 行**で済む

#### B. quality-gate.yaml（例）

```yaml
defaults:
  max_lines: 500
  coverage: 60
projects:
  danbooru_advanced_wildcard:
    coverage: 80
```

---

#### C. CLAUDE.md 抜粋（after）

```markdown
## AI完璧主義対策 ― “95%で止める”

### 禁止
- 95%→100% を狙うリファクタ
- 5 ファイル以上の同時新規作成
- 2026 年以降のロードマップ

### 自己チェック
1. 今すぐ必要か？
2. 実証された価値は？
3. 最もシンプルか？
```

> ➜ 詳細 WHY / 具体例は `docs/anti_perfectionism.md` へ移動
>  → CLAUDE.md 行数を **\~120 行** に抑止

---

#### D. 教育的ブロックのテンプレ

```text
🚫 <ViolationType>
- **原因**: <why>
- **対処**: <how>
- **再試行**: <tool re-run example>
```

Claude が Markdown を再利用しやすく、ユーザにも読みやすい。

---

### 4. ロードマップ（追加複雑性を最小化）

| フェーズ                | 期間    | 作業量 | 複雑性増加   | 成果                          |
| ------------------- | ----- | --- | ------- | --------------------------- |
| **0️⃣ 準備**          | 0.5 d | ▲   | 0       | `quality-gate.sh` 骨格＋YAML読込 |
| **1️⃣ 移行**          | 1 d   | ▲▲  | +1 ファイル | 既存 3 Hook を統合し旧ファイル削除       |
| **2️⃣ メッセージ刷新**     | 0.5 d | ▲   | ±0      | テンプレ差し替え                    |
| **3️⃣ ログ→SQLite**   | 0.5 d | ▲   | +1 テーブル | violations.jsonl → DB       |
| **4️⃣ KPI HTML**    | 0.5 d | ▲   | +1 HTML | 軽量ダッシュボード生成                 |
| **5️⃣ CLAUDE.md再編** | 0.5 d | ▲   | ±0      | 抜粋＋詳細 doc 分離                |

> ※ 総増加ファイル数 **+2 (shell+html)**。既存 6 スクリプト・長文を **-4** に削減 → **ネット-2 ファイル減・総行数▲30%**。

---

### 5. 成功判定 (“機能向上×複雑性据え置き”)

| 指標           | 現状   | 目標          | 測定方法                         |
| ------------ | ---- | ----------- | ---------------------------- |
| Hook ファイル数   | 6    | **1**       | `find .claude/hooks -type f` |
| CLAUDE.md 行数 | 200± | **≤150**    | `wc -l`                      |
| 違反検出率        | 95%  | **98%**     | violationsログ                 |
| 再発率 (同違反/週)  | 8    | **≤3**      | ログ集計                         |
| ダッシュボード導入    | なし   | **HTML 1枚** | リポジトリ確認                      |

---

## まとめ

* **統合 (A,B)** で保守対象を最小化
* **抽象化 (B)** で “コード変更＝複雑化” を回避
* **教育＋フィードバック (C,D)** で Claude を迷わせず自己修正を促進
* **自動学習ループ (E)** で人手オペレーションを削減
* **軽量可視化 (F)** でフルスタック監視の“導入コスト”を先送り

これにより、**アーキテクチャの核心価値を保ったまま書類・コード総量を圧縮**し、将来的なメンテナンス負担を抑えながらガード精度を高められます。

---

### 改善ステップ別 ― **公式仕様・実装可否チェック**

| 改善ステップ                                               | 要確認ポイント                                                               | 公式・OSSソースでの確認結果                                                                                                                                                                                  | 実装可否    | 補足 / 留意点                                                                         |                                                         |
| ---------------------------------------------------- | --------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------- | -------------------------------------------------------------------------------- | ------------------------------------------------------- |
| **A. ガード統廃合<br>(`quality-gate.sh` 1 枚化 & 3 イベント対応)** | *1)* 1 プロジェクト設定で **PreToolUse / PostToolUse / Stop** を同一スクリプトに紐付けられるか | - Hooks 設定 JSON は<br>`"PreToolUse": [ { "hooks":[{type:"command",command:"…"}]} ],<br>"PostToolUse": [ … ],<br>"Stop": [ … ]`<br>のように**イベント毎に複数コマンド登録可**。同一パスのシェルを指定すれば1枚で共有できる ([Anthropic][1]) | **可**   | 環境変数`hook_event_name`(Stop 等)や stdin JSONの`tool_name`を使い、同一スクリプト内でフェーズ分岐する実装が一般的 |                                                         |
|                                                      | *2)* フック入力で **tool / event 種別** を判別できるか                               | stdin JSON に`hook_event_name`,`tool_name`,`tool_input`が含まれる ([Anthropic][1])                                                                                                                     | **可**   | `jq`や`python -mjson.tool`で簡単に分岐可能                                                |                                                         |
| **B. 動的パラメータ化<br>(`quality-gate.yaml`)**             | Hooks から **外部 YAML を読み込む自由度**                                         | Hooksは「ユーザ権限で**任意のシェル**を実行」するだけで制限なし ([Anthropic][1])                                                                                                                                            | **可**   | `yq` / `python -PyYAML` などを使って YAML→ENV へ展開すればOK（Anthropic側に特別な設定不要）             |                                                         |
| **C. CLAUDE.md 最小核化**                                | ファイル長・節構成に**仕様上の上限**はあるか                                              | CLAUDE.md は普通の Markdown。長さ制限は記載なし（読込は自動）。複数階層の CLAUDE.md をマージ可能 ([Anthropic][1])                                                                                                                 | **可**   | 150行程度でも問題なし。詳細を別 md に分離しても読み込みコスト減のみで副作用なし                                      |                                                         |
| **D. “教育的ブロック” Exit-2 + Markdown メッセージ**             | *1)* Exit code **2** で 事前/事後ブロックできるか                                  | Exit-2 は`PreToolUse`ならツール実行をブロックし`stderr`を**Claude へ自動フィードバック**する仕様 ([Anthropic][1])                                                                                                             | **可**   | Claude は `stderr` をそのまま読むので Markdown 箇条書きは視認性良好                                  |                                                         |
|                                                      | *2)* Claude が Markdown を正しく解釈し再試行できるか                                 | 公式例で **箇条書きメッセージ**を `stderr` へ出力し、Claude が修正案を生成するフローを紹介 ([Anthropic][1])                                                                                                                        | **可**   | 長文より箇条書き＋具体例の方が LLM が取り込みやすい実践知あり                                                |                                                         |
| **E. Stop-hook で違反ログ → `violations.jsonl`**          | Stop イベントで **stdout/stderr を利用しつつファイル書込**できるか                         | Stop フックは任意コマンド実行可。`stdout`/`stderr`処理仕様は Exit-0/2 と同じ ([Anthropic][1])                                                                                                                          | **可**   | CLI 例: \`jq '\[.hook\_event\_name,.violations]                                   | @json' >> logs/violations.jsonl\`<br>ログ保存先はプロジェクト内どこでも可 |
|                                                      | Claude Code **公式ログ形式**への適合                                            | CLAUDEの標準会話ログは`~/.claude/projects/<proj>/...jsonl`形式 ([Liam ERD][2])                                                                                                                             | **互換可** | violations.jsonl は独自定義で問題なし<br>（後段の SQLite 取り込みでスキーマを統一する）                       |                                                         |
| **F. 軽量 KPI ダッシュボード**                                | Claude Code 側で **HTML 生成をブロックしないか**                                   | Hooksが任意 Bash 実行可能＝`python gen_dashboard.py`で HTML 書出し可。HTML ファイル自体はただのアセットなので制限なし。                                                                                                              | **可**   | ダッシュボードは開発者閲覧用。Claude が直接読む必要はない                                                 |                                                         |

---

### まとめ — **全ステップ実装にブロッカー無し**

* **Hooks 機能仕様**（イベント種別・Exit Code 2・任意コマンド実行）は、提案した統合スクリプト／教育的ブロック／Stop ロギングに完全対応。
* **CLAUDE.md**は行数・章構成に制限なし。必要最小情報のみ残し詳細を別 md に分離しても挙動は変わらない。
* **外部 YAML/SQLite/HTML** は純粋にシェルで操作するだけなので Claude Code 側制約ゼロ。

したがって、改善戦略 A〜F は **公式仕様の範囲内で実装可能** であり、追加ライブラリ（`yq`・`sqlite3`・`observable plot` 等）のインストールとパス設定を行えば即日適用できます。

[1]: https://docs.anthropic.com/en/docs/claude-code/hooks "Hooks - Anthropic"
[2]: https://liambx.com/blog/claude-code-log-analysis-with-duckdb?utm_source=chatgpt.com "Analyzing Claude Code Interaction Logs with DuckDB - Liam ERD"