name: Governance CI

on:
  push:
    paths:
      - 'governance/**'
  pull_request:
    paths:
      - 'governance/**'

jobs:
  adr-validation:
    runs-on: ubuntu-latest
    name: ADR Format Validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js for markdown tools
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install markdown validation tools
        run: |
          npm install -g markdown-link-check
          sudo apt-get update
          sudo apt-get install -y grep coreutils
      
      - name: Validate ADR format and metadata
        run: |
          cd governance
          
          # ADR ç•ªå·ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
          echo "ðŸ” Checking for duplicate ADR numbers..."
          adr_numbers=$(ls adr/*.md 2>/dev/null | sed 's/.*\/\([0-9]*\)-.*/\1/' | sort)
          duplicate_numbers=$(echo "$adr_numbers" | uniq -d)
          
          if [ -n "$duplicate_numbers" ]; then
            echo "âŒ ERROR: Duplicate ADR numbers found: $duplicate_numbers"
            exit 1
          else
            echo "âœ… No duplicate ADR numbers found"
          fi
          
          # ADR ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
          echo "ðŸ” Validating ADR required sections..."
          exit_code=0
          
          for file in adr/*.md; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              
              # å¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å­˜åœ¨ç¢ºèª
              if ! grep -q "^## Status" "$file"; then
                echo "âŒ ERROR: Missing '## Status' section in $file"
                exit_code=1
              fi
              
              if ! grep -q "^## Context" "$file"; then
                echo "âŒ ERROR: Missing '## Context' section in $file"
                exit_code=1
              fi
              
              if ! grep -q "^## Decision" "$file"; then
                echo "âŒ ERROR: Missing '## Decision' section in $file"
                exit_code=1
              fi
              
              # Statusã®å€¤ãƒã‚§ãƒƒã‚¯
              status_line=$(grep "^## Status" -A 1 "$file" | tail -1)
              if ! echo "$status_line" | grep -E "(Proposed|Accepted|Rejected|Superseded)"; then
                echo "âš ï¸  WARNING: Invalid or missing Status value in $file. Expected: Proposed|Accepted|Rejected|Superseded"
              fi
              
              echo "âœ… $file format validation completed"
            fi
          done
          
          if [ $exit_code -ne 0 ]; then
            echo "âŒ ADR validation failed"
            exit $exit_code
          else
            echo "âœ… All ADR files passed validation"
          fi

  file-naming-lint:
    runs-on: ubuntu-latest
    name: File Naming Convention Check
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check ADR naming convention
        run: |
          echo "ðŸ” Checking ADR file naming conventions..."
          exit_code=0
          
          # ADR ãƒ•ã‚¡ã‚¤ãƒ«å: NNN-kebab-case.md
          find governance/adr -name "*.md" | while read file; do
            basename_file="$(basename "$file")"
            
            # TEMPLATE.md ã‚„ README.md ã¯é™¤å¤–
            if [[ "$basename_file" == "TEMPLATE.md" || "$basename_file" == "README.md" ]]; then
              echo "â„¹ï¸  Skipping template/readme file: $basename_file"
              continue
            fi
            
            if ! echo "$basename_file" | grep -E '^[0-9]{3}-[a-z0-9-]+\.md$'; then
              echo "âŒ ERROR: ADR naming violation: $basename_file"
              echo "   Expected format: NNN-kebab-case.md (e.g., 001-my-decision.md)"
              exit 1
            else
              echo "âœ… $basename_file follows naming convention"
            fi
          done
          
      - name: Check Meeting Minutes naming convention
        run: |
          echo "ðŸ” Checking Meeting Minutes file naming conventions..."
          
          # Meeting Minutes ãƒ•ã‚¡ã‚¤ãƒ«å: YYYY-MM-DD-topic.md
          find governance/mtg_minutes -name "*.md" | while read file; do
            basename_file="$(basename "$file")"
            
            # TEMPLATE.md ã¯é™¤å¤–
            if [[ "$basename_file" == "TEMPLATE.md" ]]; then
              echo "â„¹ï¸  Skipping template file: $basename_file"
              continue
            fi
            
            if ! echo "$basename_file" | grep -E '^[0-9]{4}-[0-9]{2}-[0-9]{2}-[a-z0-9-]+\.md$'; then
              echo "âš ï¸  WARNING: Meeting Minutes naming suggestion: $basename_file"
              echo "   Recommended format: YYYY-MM-DD-topic.md (e.g., 2025-07-13-governance-setup.md)"
            else
              echo "âœ… $basename_file follows naming convention"
            fi
          done
          
      - name: Check decision log format
        run: |
          echo "ðŸ” Checking decision_log.md format..."
          
          if [ -f governance/decision_log.md ]; then
            # ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã®ç¢ºèª
            if grep -q "| æ—¥ä»˜ | ADR" governance/decision_log.md; then
              echo "âœ… decision_log.md table format is correct"
            else
              echo "âŒ ERROR: decision_log.md table format is incorrect"
              echo "   Expected table header: | æ—¥ä»˜ | ADR | æ±ºå®šäº‹é … |"
              exit 1
            fi
          else
            echo "âš ï¸  WARNING: decision_log.md not found"
          fi

  governance-links:
    runs-on: ubuntu-latest
    name: Governance Links Validation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js for link checking
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install link checking tools
        run: |
          npm install -g markdown-link-check
          
      - name: Validate internal ADR links
        run: |
          echo "ðŸ” Checking ADR internal references..."
          exit_code=0
          
          # ADR é–“ã®ç›¸äº’å‚ç…§ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
          find governance -name "*.md" -type f | while read file; do
            echo "Checking links in $file..."
            
            # ADR-XXX å½¢å¼ã®å‚ç…§ã‚’æŠ½å‡º
            adr_refs=$(grep -o "ADR-[0-9][0-9][0-9]" "$file" 2>/dev/null || true)
            
            if [ -n "$adr_refs" ]; then
              for adr_ref in $adr_refs; do
                adr_num=$(echo "$adr_ref" | sed 's/ADR-//')
                
                # å¯¾å¿œã™ã‚‹ADRãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if ! ls governance/adr/${adr_num}-*.md >/dev/null 2>&1; then
                  echo "âŒ ERROR: Broken ADR reference $adr_ref in $file"
                  echo "   Expected file: governance/adr/${adr_num}-*.md"
                  exit 1
                else
                  echo "âœ… Valid ADR reference: $adr_ref"
                fi
              done
            fi
          done
          
      - name: Check markdown link validity
        run: |
          echo "ðŸ” Checking markdown links..."
          
          # governance ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®å…¨ markdown ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
          find governance -name "*.md" -type f | while read file; do
            echo "Running link check on $file..."
            
            # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆå¤–éƒ¨ãƒªãƒ³ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆèª¿æ•´ï¼‰
            cat > .markdown-link-check.json << 'EOF'
          {
            "timeout": "10s",
            "retryOn429": true,
            "retryCount": 2,
            "ignorePatterns": [
              {
                "pattern": "^http://localhost"
              },
              {
                "pattern": "^https://localhost"
              }
            ]
          }
          EOF
            
            # ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œï¼ˆå¤–éƒ¨ãƒªãƒ³ã‚¯ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã®ã¿ï¼‰
            if ! markdown-link-check "$file" --config .markdown-link-check.json; then
              echo "âš ï¸  WARNING: Some links in $file may be invalid"
              echo "   This will not fail the CI, but please review the links"
            else
              echo "âœ… All links in $file are valid"
            fi
          done

  governance-summary:
    runs-on: ubuntu-latest
    name: Governance Health Check
    needs: [adr-validation, file-naming-lint, governance-links]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Generate governance summary
        run: |
          echo "ðŸ“Š Governance Health Summary"
          echo "================================"
          
          # ADR ãƒ•ã‚¡ã‚¤ãƒ«æ•°
          adr_count=$(find governance/adr -name "*.md" -not -name "TEMPLATE.md" | wc -l)
          echo "ðŸ“ ADR files: $adr_count"
          
          # Meeting Minutes ãƒ•ã‚¡ã‚¤ãƒ«æ•°
          mtg_count=$(find governance/mtg_minutes -name "*.md" -not -name "TEMPLATE.md" | wc -l)
          echo "ðŸ“ Meeting Minutes: $mtg_count"
          
          # Decision Log ã®æœ€çµ‚æ›´æ–°
          if [ -f governance/decision_log.md ]; then
            last_updated=$(grep "æœ€çµ‚æ›´æ–°:" governance/decision_log.md | tail -1 || echo "æ›´æ–°æ—¥ä¸æ˜Ž")
            echo "ðŸ“… Decision Log: $last_updated"
          fi
          
          # CI ã‚¸ãƒ§ãƒ–çµæžœè¡¨ç¤º
          echo ""
          echo "ðŸ” CI Job Results:"
          echo "- ADR Validation: ${{ needs.adr-validation.result }}"
          echo "- File Naming: ${{ needs.file-naming-lint.result }}"
          echo "- Link Validation: ${{ needs.governance-links.result }}"
          
          echo ""
          echo "âœ… Governance CI completed"